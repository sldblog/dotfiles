#!/bin/bash

DOTFILES="$(cd $(dirname $0)/.. && pwd)"
UNAME="$(uname)"

function msg_progress {
  echo -e "\n\033[33mðŸ•µ $1\033[0m"
}

function msg_done {
  echo -e "\n\033[32mâœ³ Done!\033[0m"
}

function install_zsh {
  msg_progress "Installing oh-my-zsh."

  git clone git@github.com:robbyrussell/oh-my-zsh.git $HOME/.oh-my-zsh
}

function symlink_files {
  msg_progress "Linking files."

  for file in .zshenv .zshrc; do
    ln -si "$DOTFILES/zsh/$file" "$HOME/$file"
  done

  for file in .gemrc .vimrc .agignore .iex.exs; do
    ln -si "$DOTFILES/configuration/$file" "$HOME/$file"
  done

  mkdir -p $HOME/.gnupg && chmod 700 $HOME/.gnupg
  ln -si "$DOTFILES/configuration/gpg-agent.conf" "$HOME/.gnupg/gpg-agent.conf"

  mkdir -p $HOME/.lein
  ln -si "$DOTFILES/configuration/lein-profiles.clj" "$HOME/.lein/profiles.clj"

  local vscode_settings_location=""
  if [ "$UNAME" == "Linux" ]; then
    vscode_settings_location="$HOME/.config/Code - OSS/User/settings.json"
  else
    vscode_settings_location="$HOME/Library/Application Support/Code/User/settings.json"
  fi
  ln -si "$DOTFILES/configuration/vscode.user-settings.json" "$vscode_settings_location"
}

function install_dependencies {
  msg_progress "Installing dependencies."

  if [ "$UNAME" == "Linux" ]; then
    local packages=$(tr '\n' ' ' < $DOTFILES/Pacmanfile)
    msg_progress "May ask for sudo password."
    sudo pacman --sync --refresh
    sudo pacman --sync --needed --noconfirm $packages
  else
    brew bundle --file=$DOTFILES/Brewfile
  fi
  pip install --upgrade --requirement $DOTFILES/Pipfile
}

function apply_git_config {
  msg_progress "Applying git configuration."

  git config --global user.email "david.lantos@gmail.com"
  git config --global user.name "David Lantos"

  git config --global user.signingkey "0x46744D6E3CC64734"
  git config --global commit.gpgsign "true"

  git config --global core.excludesfile "$DOTFILES/configuration/.gitignore"
  git config --global push.default "simple"

  git config --global mergetool.keepBackup "false"

  if [ "$UNAME" == "Darwin" ]; then
    git config --global merge.tool "p4merge"
    git config --global diff.tool "p4merge"
    git config --global mergetool.p4merge.path "/Applications/p4merge.app/Contents/MacOS/p4merge"
  fi

  git config --global alias.rl "reflog --date=iso"
  git config --global alias.ll "log --graph --pretty=format:'%C(yellow)%h%Creset -%C(green)%d%Creset %s %Cblue(%cr - %cd) %C(bold blue)<%ae>%Creset' --abbrev-commit"

  git lfs install
}

function install_zsh_addons {
  msg_progress "Installing zsh addons."

  theme_file="$HOME/.oh-my-zsh/themes/bullet-train.zsh-theme"
  rm -f $theme_file
  curl --silent https://raw.githubusercontent.com/caiogondim/bullet-train-oh-my-zsh-theme/master/bullet-train.zsh-theme \
    -o $theme_file && echo "zsh theme $(basename $theme_file) installed"
}

function install_vim_addons {
  msg_progress "Installing vim addons."

  mkdir -p $HOME/.vim/bundle/
  git clone https://github.com/VundleVim/Vundle.vim.git $HOME/.vim/bundle/Vundle.vim
  vim +PluginInstall +qall && echo "vim plugins installed"
}

install_zsh
symlink_files
install_dependencies
install_vim_addons
install_zsh_addons
apply_git_config

msg_done
